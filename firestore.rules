rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper functions
    // =========================================================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // =========================================================================
    // Subscriptions â€” public create (email only), admin read
    // =========================================================================
    match /subscriptions/{subscriptionId} {
      allow create: if request.resource.data.email is string;
      allow read: if isAdmin();
    }

    // =========================================================================
    // Users (propietarios / comerciantes)
    // Any authenticated user can read profiles.
    // Only the document owner can write their own profile.
    // Admins can read and update any user (for verification, bans, etc.).
    // =========================================================================
    match /usersPropietariosResidentes/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if false;
    }

    match /usersComerciantesCalificados/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if false;
    }

    // =========================================================================
    // Drafts (service requirements posted by propietarios)
    // Readable by all authenticated users (marketplace listing).
    // Only the creator (draftPropietarioResidente) can write.
    // Admins can read all drafts for reporting.
    // =========================================================================
    match /drafts/{draftId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
        && (resource.data.draftPropietarioResidente == request.auth.uid
            || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['draftApply']));
      allow delete: if false;
    }

    // =========================================================================
    // Quotations (proposals sent by comerciantes)
    // =========================================================================
    match /quotations/{quotationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }

    // =========================================================================
    // Contracts (created when a quotation is accepted)
    // Readable by client, provider, or admin.
    // =========================================================================
    match /contracts/{contractId} {
      allow read: if isAuthenticated()
        && (resource.data.clientId == request.auth.uid
            || resource.data.providerId == request.auth.uid
            || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
        && (resource.data.clientId == request.auth.uid
            || resource.data.providerId == request.auth.uid
            || isAdmin());
      allow delete: if false;
    }

    // =========================================================================
    // Asesorias (technical advisory Q&A)
    // =========================================================================
    match /asesorias/{asesoriaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }

    // =========================================================================
    // Catch-all: deny everything else
    // =========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}